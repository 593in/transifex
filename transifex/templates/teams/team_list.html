{% load i18n %}
{% load txcommontags %}
{% load permissions %}
{% load txpermissions %}
{% load statistics_resources %}
{% load addons %}
{% load project_tags %}

{% get_permission "project_perm.maintain" for request.user and project as "is_maintainer" %}
<script type="text/javascript">
  $(document).ready(function(){
    $(".tablesorter_resource_list").tablesorter({
      sortList: [[0,0]],
      textExtraction: function(node) {
        switch (node.cellIndex){
            // Stats column
            case 1:
                return $(".stats_string_resource", node).text();
            // Last update column
            case 2:
                return $("span", node).attr('unixdate');
            default: return node.innerHTML;
        }
      }        
    });
  });
</script>


<div class="obj_bigdetails">

<div class="project_create">

  <div class="separate-header clearfix">
  	<h3 class="sh-label notopmargin">{% trans "Languages" %}</h3>
		<div class="separate-buttons">
		  {% if request.user.is_authenticated and not is_maintainer %}
      <a class="i16 language-add" id="request-team-button" href="javascript:;">Request language</a>
      {% endif %}
      {% if perms.projects.change_team or is_maintainer %}
		  <a class="i16 nude-button add" href="{% url team_create project.slug %}">{% trans "Create Language" %}</a>
      {% endif %}
		</div>
	</div> 

  {% if team_request_form %}
  {% if request.user.is_authenticated and not is_maintainer %}
  <form id="request-team-form" method="post" enctype="multipart/form-data" action="{% url team_request project.slug %}" class="add-permission submit_form tx-form">{% csrf_token %}
    <table>
      <tbody>{% form_as_table_rows team_request_form %}</tbody>
    </table>
  
    {% hook "team_request_join_additional.html" %}
  
    <p class="submit">
      <input name="team_request" class="i16 submit buttonized" type="submit" value="{% trans "Request team" %}"/>
    </p>
  
  </form>
  {% endif %}
  {% endif %}

  {% with project.teamrequest_set.all|dictsort:"language.name" as teamrequests %}
  {% if teamrequests and request.user.is_authenticated %}
  <div class="datalist">
    <ul class="nomargin">
    {% for teamrequest in teamrequests %}
      <li class="clearfix requested-row">
        <div class="tt-details">
          <h5>{{ teamrequest.language.name }}</h5>
          <span class="ttd-extra">(Requester: <a href="{% url profile_public teamrequest.user.username %}">{{ teamrequest.user.username }}</a>)</span>
      	</div>
        {% if is_maintainer %}
        <form class="microform" method="post" action="{% url team_request_deny teamrequest.project.slug teamrequest.language.code %}">{% csrf_token %}
          <input name="team_request_deny" class="i16 delete blist buttonized" type="submit" value="{% trans "Deny" %}"/>
        </form>
        <form class="microform" method="post" action="{% url team_request_approve teamrequest.project.slug teamrequest.language.code %}">{% csrf_token %}
          <input name="team_request_approve" class="i16 submit blist buttonized" type="submit" value="{% trans "Approve" %}"/>
        </form>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}
  {% endwith %}

  {% with project.team_set.all|dictsort:"language.name" as teams %}
  {% if teams %}
  <table class="stats-table tablesorter_resource_list">
    <thead>
     <tr>
      <th class="onlyarrow"></th>
      <th class="onlyarrow"></th>
      <th class="onlyarrow"></th>
     </tr>
    </thead>
  <tbody>
    {% for team in teams %}
	    <tr>
        <td>
	        <h5><a href="{% url team_detail team.project.slug team.language.code %}">{{ team.language.name }}</a></h5>
        </td>
	      <td class="completion">
	        {% with 180 as width%}
	          {% progress_for_project team.project team.language.code width %}
	        {% endwith %}
	      </td>
	      <td class="membercount">
	       <a href="{% url team_members project.slug team.language.code %}">
         {{team.members.all.count}} translators <span style="color:#758CA3;">({{ team.members.all.count|add:team.reviewers.all.count|add:team.coordinators.all.count }}{% blocktrans %} members in total{% endblocktrans %})</span>
         </a>
	      </div>
	      </td>
	    </tr>
    {% endfor %}
  </tbody>
  </table>
  {% else %}
  <p class="i16 infomsg">{% trans "No translation team has been created yet. Why don't you start one?" %}</p>
  {% endif %}
  {% endwith %}

</div>
</div>