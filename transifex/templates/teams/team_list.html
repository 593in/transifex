{% load i18n %}
{% load txcommontags %}
{% load permissions %}
{% load txpermissions %}
{% load statistics_resources %}
{% load addons %}
{% load project_tags %}
{% load team_tags %}
{% load resources_common_tags %}

{% get_permission "project_perm.maintain" for request.user and project as "is_maintainer" %}

<script type="text/javascript">
$(document).ready(function (){
  $("#langmemb-switch").click(function(){
  var current_btn = $(this).find(".linkstyle");
  
  if(current_btn.hasClass("alllangs")){
    current_btn.removeClass("alllangs").addClass("onlymembers").text("(Show all languages)");  
    $("table.stats-table tr.nomembers:not(.sourcelang)").hide();
    }
  else{
    current_btn.removeClass("onlymembers").addClass("alllangs").text("(Show only those accepting translators)");
    $(".stats-table tr.nomembers:not(.sourcelang)").show();
    }
  
  })
});
</script>

<div class="obj_bigdetails">

<div class="project_create">

  <div class="separate-header clearfix">
  	<h3 class="sh-label notopmargin">{% trans "Languages" %}</h3>
		  <div id="langmemb-switch-container left" style="margin-bottom:0.2em;">
    <div id="langmemb-switch">
      <span class="linkstyle left alllangs" style="margin-top:6px;margin-bottom:0;font-size:0.923em;">{% trans "(Show only those accepting translators)" %}</span>
    </div>
  </div>
		<div class="separate-buttons">
		  {% if request.user.is_authenticated and not is_maintainer and not project.outsource %}
      <a class="i16 language-add" id="request-team-button" href="javascript:;">Request language</a>
      {% endif %}
      {% if not project.anyone_submit and not project.outsource %}
        {% if perms.projects.change_team or is_maintainer %}
		    <a class="i16 nude-button add" href="{% url team_create project.slug %}">{% trans "Create language" %}</a>
        {% endif %}
      {% endif %}
		</div>
	</div>

  {% if team_request_form %}
  {% if request.user.is_authenticated and not is_maintainer %}
  <form id="request-team-form" method="post" enctype="multipart/form-data" action="{% url team_request project.slug %}" class="add-permission submit_form tx-form">{% csrf_token %}
    <table>
      <tbody>{% form_as_table_rows team_request_form %}</tbody>
    </table>

    {% hook "team_request_join_additional.html" %}

    <p class="submit">
      <input name="team_request" class="i16 submit buttonized" type="submit" value="{% trans "Request team" %}"/>
    </p>

  </form>
  {% endif %}
  {% endif %}

  {% if team_requests and request.user.is_authenticated %}
  <div class="datalist" style="margin-bottom:0.8em;">
    <ul class="nomargin">
    {% for team_request in team_requests %}
      <li class="clearfix requested-row">
        <div class="tt-details">
          <span class="tipsy_enable" title="language code: {{ team_request.language.code }}">{{ team_request.language.name }}</span>
          <span class="ttd-extra">(Requester: <a href="{% url profile_public team_request.user.username %}">{{ team_request.user.username }}</a>)</span>
      	</div>
        {% if is_maintainer %}
        <form class="microform" method="post" action="{% url team_request_deny team_request.project.slug team_request.language.code %}">{% csrf_token %}
          <input name="team_request_deny" class="i16 delete blist buttonized" type="submit" value="{% trans "Deny" %}"/>
        </form>
        <form class="microform" method="post" action="{% url team_request_approve team_request.project.slug team_request.language.code %}">{% csrf_token %}
          <input name="team_request_approve" class="i16 submit blist buttonized" type="submit" value="{% trans "Approve" %}"/>
        </form>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if language_stats %}
  <table class="stats-table tablesorter teamlist">
    <thead>
     <tr>
      <th class="onlyarrow tableobject"></th>
      <th class="onlyarrow tablecompletion"></th>
      <th class="onlyarrow tablelastupd"></th>
     </tr>
    {% with source_languages|language_codes_list as source_language_codes %}
    {% for stat in language_stats|sort_source_langs_first:source_languages %}
    {% if stat.first_translation %}
      </thead>
      <tbody>
    {% endif %}
	<tr {% if not stat.object.code in available_teams_codes %} class="nomembers{% if stat.object.code in source_language_codes  %} sourcelang{%endif%}" {% endif %} >
    <td class="tableobject">
    
    {% if not project.outsource %}
      <a href="{% url team_detail project.slug stat.object.code %}"  class="tipsy_enable" title="language code: {{ stat.object.code }}" >{{ stat.object.name }}</a>
    {% else %}
      <a href="{% url team_detail project.outsource.slug stat.object.code %}?projects={{ project.id }}"  class="tipsy_enable" title="language code: {{ stat.object.code }}" >{{ stat.object.name }}</a>
    {% endif %}

    {% if stat.object.code in source_language_codes  %}
      <span style="color:#aaa;">({% trans "source language "%})</span>
    {% else %}
      {% if stat.object.code in available_teams_codes %}
        {% with stat.object.code as lang_code %}
          {% with teams|getitem:lang_code as team_counts %}
            {% if team_counts.1 %}
            <a class="tteamstats  tipsy_enable" title="{% blocktrans with teams|getitem:lang_code as team_counts %}this language has {{ team_counts.1 }} members{% endblocktrans %}" href="{% if project.outsource %} {% url team_members project.outsource.slug lang_code %} {% else %}{% url team_members project.slug lang_code %}{% endif %}">
              <span>{{ team_counts.1 }}</span>
            </a>
            {% endif %}
            {% if team_counts.0 %}
            <a class="tteamstats gray tipsy_enable" title="{% blocktrans %}there are {{ team_counts.0 }} join requests{% endblocktrans %}" href="{% if project.outsource %} {% url team_members project.outsource.slug lang_code %} {% else %}{% url team_members project.slug lang_code %}{% endif %}">
              <span>{{ team_counts.0 }}</span>
            </a>
            {% endif %}
          {% endwith %}
        {% endwith %}
      {% endif %}
    {% endif %}
    </td>
    <td class="tablecompletion">    
      {% with 180 as barwidth %}
          {% stats_bar_simple stat barwidth %}
      {% endwith %}
    </td>
    <td class="tablelastupd">
      <span  class="i16 table-update tipsy_enable" title="{% trans 'Last update' %}" unixdate="{{ stat.last_update|date:'U' }}">{{ stat.last_update|date:"M d, h:ia" }}</span>
    </td>
  </tr>
  {% endfor %}
  {% endwith %}
  </tbody>
  </table>
  {% else %}
  <p class="i16 infomsg">{% trans "No translation team has been created yet. Why don't you start one?" %}</p>
  {% endif %}

</div>
</div>
