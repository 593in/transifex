{% extends "teams/team_menu.html" %}
{% load i18n %}
{% load cache %}
{% load pagination_tags %}
{% load txcommontags %}
{% load permissions %}
{% load txpermissions %}
{% load addons %}
{% load statistics_resources %}

{% block extra_head %}
<script type="text/javascript">
  $(function(){
    $(".tipsy_enable").tipsy({'html':true, 'gravity':'s'});
    $("#join-facebox-trigger").facebox();
   })
</script>
{% endblock %}

{% block title %}{{ block.super }} | {{ project.name }}{% endblock %}


{% block content_main %}
{% get_permission "project_perm.submit_translations" for request.user and team as "can_submit_translations" %}
{% get_permission "project_perm.coordinate_team" for request.user and project,language as "is_coordinator" %}

<div class="obj_bigdetails">

 	<div class="separate-header notopmargin clearfix">
  	<h3  class="sh-label">{% trans "Details" %}</h3>
  	<div class="separate-buttons">
  	{% if perms.projects.change_team or is_coordinator %}
  		<a class="i16 edit nude-button" href="{% url team_update project.slug language.code %}">{% trans "Edit language" %}</a>
		{% endif %}
		
		{% if request.user.is_authenticated and not perms.projects.submit_translations and not can_submit_translations and not user_access_request %}	  
			<a id="join-facebox-trigger" class="i16 team_join nude-button" href="#facebox-joinmember">{% trans 'Join language translation' %}</a>	
		{% endif %}
	  </div>

	  <div class="no-display">
		{% if request.user.is_authenticated and not perms.projects.submit_translations and not can_submit_translations and not user_access_request %}	  
		<div id="facebox-joinmember"  class="facebox-content">
		<div class="facebox-content">
      {% if team %}
	    <form method="post" action="{% url team_join_request project.slug language.code %}" class="microform">{% csrf_token %}
	      <p>{% hook "team_request_join_additional.html" %}</p>
	      <p><input name="team_join" class="i16 tick buttonized" type="submit" title="{% trans 'Join language translation' %}" value="{% trans 'Join language translation' %}"></p>
	    </form>
	    {% else %}
      <form method="post" enctype="multipart/form-data" action="{% url team_request project.slug %}" class="microform">{% csrf_token %}
        <input type="hidden" name="language" value="{{ language.pk }}" id="id_language">
        <input type="hidden" name="project" value="{{ project.pk }}" id="id_project">
	      <p>{% hook "team_request_join_additional.html" %}</p>
	      <p><input name="team_join" class="i16 tick buttonized" type="submit" title="{% trans 'Join language translation' %}" value="{% trans 'Join language translation' %}"></p>
      </form>
	    {% endif %}
		</div>
	  </div>
		{% endif %}
	  
	  </div>

	</div>


<div class="team_detail">
  <dl class="definition clearfix">
    {% if team.mainlist %}
      <dt class="i16 email">{% trans "Mainlist:" %}</dt>
      <dd>{{ team.mainlist|mungify:team.mainlist }} </a></dd>
    {% endif %}

    {% with team.coordinators.all as coordinators %}
    {% if coordinators %}
      <dt class="i16 coordinators">{% blocktrans count coordinators|length as counter %}Coordinator:{% plural %}Coordinators:{% endblocktrans %}</dt>
      <dd>
        {% for c in coordinators|slice:"0:6" %}
          <img class="border" width="16" height="16" src="{{ c.profile.get_mugshot_url }}" style="vertical-align:middle"/>
          {% if c.first_name and c.last_name %}
          	<a href="{% url profile_public c.username %}">{{c.username}}</a>
          {% endif %}
        {% endfor %}
      </dd>
    {% endif %}
    {% endwith %}
  </dl>
</div>


<div class="list" style="clear:both">

  <div class="separate-header clearfix">
  	<h3  class="sh-label">{% blocktrans %}Language resources{% endblocktrans %}</h3>
	</div>
	
  {% if statslist %}
  <table class="stats-table tablesorter langdetail">
  <thead>
    <tr>
      <th class="onlyarrow tableobject"></th>
      <th class="onlyarrow tablecompletion"></th>
      <th class="onlyarrow tablelastupd"></th>
      <th class="onlyarrow priority_level"></th>
    </tr>
  </thead>
  <tbody>

  {% for stat in statslist %}

  <tr id="stat_row_{{forloop.counter}}" title="{% trans 'click for translation' %}">
  {% cache 604800 team_details team.id stat.resource.id LANGUAGE_CODE %}
        <td class="tableobject">
        <span class="linkstyle">{% if project.is_hub %}{{ stat.resource.project.name }}&nbsp;&rarr;&nbsp;{% endif %} {{ stat.resource.name }}</span>
        {% if stat.lock.valid %}
            <img class="tipsy_enable bullet" src="{{ STATIC_URL }}images/icons/bullet_lock.png" title="{% trans "Locked" %}"/>
        {% else %}
          {% if stat.resource.accept_translations %}
            <img class="tipsy_enable bullet" src="{{ STATIC_URL }}images/icons/bullet_green.png" title="{% trans "Accepting translations" %}"/>
          {% else %}
            <img class="tipsy_enable bullet" src="{{ STATIC_URL }}images/icons/bullet_delete.png" title="{% trans "Not accepting translations at the moment" %}"/>
          {% endif %}
        {% endif %}
        </td>
        <td class="tablecompletion">
        {% with 200 as barwidth %}
            {% stats_bar_simple stat barwidth %}
        {% endwith %}
        </td>
  {% endcache %}
        <td class="tablelastupd">
        {% with stat.last_update as last_update %}
          <span  class="i16 table-update tipsy_enable" title="{% trans 'Last update' %}" unixdate="{{ last_update|date:'U' }}">
          {% with stat.last_committer as last_committer %}
          {% if last_update %}
            {{ last_update|date:"M d, h:ia" }}
          {% else %}
            {% trans "no activity yet" %}
          {% endif %}
        {% endwith %}
      </span>
      {% endwith %}
    </td>

    <td class="priority_level" style="text-align:center">
      <span style="border:0">
        {% with stat.resource.priority.level as priority_level %}
        {% with stat.resource.priority.display_level as display_level %}
          <span class="priority_sort" style="display:none">{{ priority_level }}</span>
          <img class="tipsy_enable" src="{{ STATIC_URL }}priorities/images/{{ display_level }}.png" style="border:0" title="Priority: {{ display_level }}"/>
        {% endwith %}
        {% endwith %}
      </span>
    </td>
  </tr>

  <script type="text/javascript">
    jQuery(document).ready(function($){
      $("#stat_row_{{forloop.counter}}").click(function(){
      	jQuery.facebox({ ajax: '{% url resource_actions project.slug stat.resource.slug language.code %}' })
      });
		})
  </script>
  {% endfor %}
  </table>
  {% else %}
    <p>{% trans "No resources are registered for this project yet." %}</p>
  {% endif %}
</div>

</div>

{% if team %}
<div class="separate-header clearfix">
	<h3  class="sh-label">{% trans "History" %}</h3>
</div>
{% load tx_action_log %}
{% get_log 5 as action_log for_object team %}
{% if not action_log %}
<p>{% trans 'None available' %}</p>
{% else %}
<ul class="actionlist nomargin">
{% for entry in action_log %}
	<li class="i16 {{entry.action_type}}">
	    <p>{{ entry.message|safe }}</p> 
	    <span class="timestamp">{{ entry.action_time|timesince }} ago</span>
	</li>
{% endfor %}
</ul>
{% endif %}
{% endif %}

{% endblock %}


{% block content_footer %}
  <div id="content_footer_center"></div>
{% endblock %}
